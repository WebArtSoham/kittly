{%- comment -%}
  Renders tiered pricing (Black > Gold > Silver) based on customer tags.
  All logged-in users see at least Silver-level price.
  Guests see login prompt.

  Accepts same args as original: product, use_variant, show_badges, price_class
{%- endcomment -%}

{%- if customer -%}
  {%- liquid
    assign tier = 'silver'

    if customer.tags contains 'black'
      assign tier = 'black'
    elsif customer.tags contains 'gold'
      assign tier = 'gold'
    endif

    # Decide base target
    if use_variant
      assign target = product.selected_or_first_available_variant
    else
      assign target = product
    endif

    assign price           = target.price | default: 0
    assign compare_at_price = target.compare_at_price
    assign available       = target.available | default: false

    # Find tier-specific variant (search in option1/2/3)
    for variant in product.variants
      assign opt = variant.option1 | append: ' ' | append: variant.option2 | append: ' ' | append: variant.option3 | downcase

      if tier == 'black' and opt contains 'black'
        assign target = variant
        assign price = variant.price
        assign compare_at_price = variant.compare_at_price
        assign available = variant.available
        break
      elsif tier == 'gold' and opt contains 'gold'
        assign target = variant
        assign price = variant.price
        assign compare_at_price = variant.compare_at_price
        assign available = variant.available
        break
      elsif tier == 'silver' and opt contains 'silver'
        assign target = variant
        assign price = variant.price
        assign compare_at_price = variant.compare_at_price
        assign available = variant.available
        break
      endif
    endfor

    # Format displayed price
    if settings.currency_format_enable
      assign money_price = price | money_with_currency
    else
      assign money_price = price | money
    endif

    if target == product and product.price_varies
      assign money_price = 'products.product.price.from_price_html' | t: price: money_price
    endif
  -%}

  <div class="price
      {%- if price_class %} {{ price_class }}{% endif -%}
      {%- if available == false %} price--sold-out{% endif -%}
      {%- if compare_at_price > price %} price--on-sale{% endif -%}
      {%- if product.price_varies == false and product.compare_at_price_varies %} price--no-compare{% endif -%}
      {% if price_style == '2' %} price-style-2{% endif %}"
      data-customer-tier="{{ tier }}">

    <dl>
      <div class="price__regular">
        <dd class="price__last">
          <span class="price-item price-item--regular">{{ money_price }}</span>
        </dd>
      </div>

      <div class="price__sale{% if settings.show_saved_price %} show_saved_price{% endif %}">
        <dd class="price__compare" data-compare="{{ compare_at_price }}">
          <s class="price-item price-item--regular">
            {%- if settings.currency_format_enable -%}
              {{ compare_at_price | money_with_currency }}
            {%- else -%}
              {{ compare_at_price | money }}
            {%- endif -%}
          </s>
        </dd>

        <dd class="price__last{% if settings.show_price_percent %} price_percent{% endif %}" data-last="{{ price }}">
          <span class="price-item price-item--sale">{{ money_price }}</span>
        </dd>

        {%- if settings.show_saved_price and compare_at_price > price -%}
          {%- assign saved = compare_at_price | minus: price | money -%}
          <div class="price__saved">
            <span class="price-item price-item--saved">
              {{ 'products.product.price.saved_price_html' | t: price: saved }}
            </span>
          </div>
        {%- endif -%}

        {%- if settings.show_price_percent -%}
          <dd class="price__label_sale price__label_percent">
            {%- liquid
              assign max_saving = 0
              assign list = product.variants | where: 'compare_at_price'
              for v in list
                assign saving = v.compare_at_price | minus: v.price | times: 100.0 | divided_by: v.compare_at_price | round
                if saving > max_saving
                  assign max_saving = saving
                endif
              endfor
              if max_saving < 1 and product.compare_at_price_min > product.price_min
                assign max_saving = product.compare_at_price_min | minus: product.price_min | times: 100.0 | divided_by: product.compare_at_price_min | round
              endif
            -%}
            <span class="label_sale label_sale_percent">(-{{ max_saving }}%)</span>
          </dd>
        {%- endif -%}
      </div>

      <small class="unit-price caption{% if available == false or target.unit_price_measurement == nil %} hidden{% endif %}">
        <dd class="price__last">
          <span>{{ target.unit_price | money }}</span
          ><span aria-hidden="true">/</span
          ><span class="visually-hidden">&nbsp;{{ 'accessibility.unit_price_separator' | t }}&nbsp;</span
          ><span>
            {%- if target.unit_price_measurement.reference_value != 1 -%}
              {{- target.unit_price_measurement.reference_value -}}
            {%- endif -%}
            {{ target.unit_price_measurement.reference_unit }}
          </span>
        </dd>
      </small>
    </dl>
  </div>

{%- else -%}

  <div class="price price--login-required {{ price_class }}">
    <p class="price__login-message">
      <a href="{{ routes.account_login_url }}">Login</a> to see your tiered price
    </p>
  </div>

{%- endif -%}